<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<link rel="manifest" href="/manifest.json">
<title>FriendChess</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body { background:#222; color:white; font-family:sans-serif; text-align:center; }
.board { display:grid; grid-template-columns:repeat(8,60px); width:480px; margin:20px auto; }
.square { width:60px; height:60px; display:flex; align-items:center; justify-content:center;
          font-size:34px; cursor:pointer; }
.white { background:#eee; color:black; }
.black { background:#555; }
.selected { outline:3px solid red; }
.highlight { outline:3px solid yellow; }

.own { color:#00ff88; }
.enemy { color:#ff5555; }

.chat { width:480px; margin:auto; border:1px solid #555; padding:5px; }
.chatlog { height:140px; overflow-y:auto; text-align:left; font-size:14px; }

#turn { font-weight:bold; margin:10px; font-size:18px; }

.clock { display:flex; justify-content:space-between; width:480px; margin:auto; font-size:20px; margin-bottom:10px; }
.clock div { padding:5px 10px; background:#222; border:1px solid #444; }
</style>
</head>

<body>
<h1>Rapid FriendChess</h1>
<p id="info">Verbinde‚Ä¶</p>
<p id="turn">Am Zug: ‚Ä¶</p>

<div class="clock">
    <div id="whiteClock">06:07</div>
    <div id="blackClock">06:07</div>
</div>

<div class="board" id="board"></div>

<div class="chat">
    <div class="chatlog" id="chatlog"></div>
    <input id="chatinput" placeholder="Nachricht‚Ä¶" />
    <button onclick="sendChat()">Senden</button>
</div>

<script>
const socket = io();
const moveSound = new Audio("/sounds/ficha-de-ajedrez-34722.mp3");
const boardDiv = document.getElementById("board");
const chatlog = document.getElementById("chatlog");
const info = document.getElementById("info");
const turnDisplay = document.getElementById("turn");
const whiteClockEl = document.getElementById("whiteClock");
const blackClockEl = document.getElementById("blackClock");

let selected = null;
let state = {};
let playerColor = null;
let lastMove = null;
let clocks = {white:367, black:367};
let gameEnded = false;

// üî• EJS statt Flask
const room_id = "<%= room_id %>";

const pieces = [
 ["‚ôñ","‚ôò","‚ôó","‚ôï","‚ôî","‚ôó","‚ôò","‚ôñ"],
 ["‚ôô","‚ôô","‚ôô","‚ôô","‚ôô","‚ôô","‚ôô","‚ôô"],
 ["","","","","","","",""],
 ["","","","","","","",""],
 ["","","","","","","",""],
 ["","","","","","","",""],
 ["‚ôü","‚ôü","‚ôü","‚ôü","‚ôü","‚ôü","‚ôü","‚ôü"],
 ["‚ôú","‚ôû","‚ôù","‚ôõ","‚ôö","‚ôù","‚ôû","‚ôú"]
];

// ------------- NEU: STATE ALS UCI -------------
function initBoard(){
    for(let y=0;y<8;y++){
        for(let x=0;x<8;x++){
            if(pieces[y][x]){
                const file = String.fromCharCode(97 + x);   // a-h
                const rank = (8 - y).toString();            // 8-1
                state[file + rank] = pieces[y][x];
            }
        }
    }
}
initBoard();

// ------------- BOARD ZEICHNEN (mit Rotation) -------------
function draw(){
    if(gameEnded) return;
    boardDiv.innerHTML="";

    const yRange = playerColor==="black" ? [...Array(8).keys()] : [...Array(8).keys()].reverse();
    const xRange = playerColor==="black" ? [...Array(8).keys()].reverse() : [...Array(8).keys()];

    for(let y of yRange){
        for(let x of xRange){
            const file = String.fromCharCode(97 + x);
            const rank = (8 - y).toString();
            const key = file + rank;

            const sq = document.createElement("div");
            sq.className = "square " + ((x+y)%2 ? "black":"white");

            if(key===selected) sq.classList.add("selected");
            if(lastMove && (key===lastMove.from || key===lastMove.to)) sq.classList.add("highlight");

            sq.textContent = state[key] || "";

            if(state[key]){
                const isWhite = "‚ôô‚ôñ‚ôò‚ôó‚ôï‚ôî".includes(state[key]);
                const own = (playerColor==="white" && isWhite) || (playerColor==="black" && !isWhite);
                sq.classList.add(own ? "own" : "enemy");
            }

            sq.onclick = ()=>clickSquare(key);
            boardDiv.appendChild(sq);
        }
    }
}

// ------------- KLICK ‚Üí UCI (Korrekt!) -------------
function clickSquare(key){
    if(!playerColor || gameEnded) return;
    if(selected){
        socket.emit("move",{
            from: selected,
            to: key,
            room: room_id
        });
        selected=null;
    } else if(state[key]) selected=key;
    draw();
}

function sendChat(){
    const i=document.getElementById("chatinput");
    if(i.value.trim()){
        socket.emit("chat",{msg:i.value,room:room_id});
        i.value="";
    }
}

function fmt(t){ return `${Math.floor(t/60).toString().padStart(2,"0")}:${(t%60).toString().padStart(2,"0")}`; }

function checkTimeEnd(){
    if(gameEnded) return;
    if(clocks.white <=0){
        gameEnded = true;
        alert("Schwarz gewinnt! Zeit von Wei√ü abgelaufen.");
    }
    if(clocks.black <=0){
        gameEnded = true;
        alert("Wei√ü gewinnt! Zeit von Schwarz abgelaufen.");
    }
}

setInterval(()=>{
    if(!playerColor || gameEnded) return;
    const turn = turnDisplay.textContent.includes("white")?"white":"black";
    if(clocks[turn]>0) clocks[turn]--;
    whiteClockEl.textContent = fmt(clocks.white);
    blackClockEl.textContent = fmt(clocks.black);
    checkTimeEnd();
},1000);

socket.emit("join",{room:room_id});

socket.on("player",d=>{
    playerColor=d.color;
    info.textContent="Du bist "+playerColor;
    if(d.time) clocks=d.time;
    draw();
});

socket.on("move",d=>{
    if(d.promotion) state[d.to]=d.promotion;
    else { state[d.to]=state[d.from]; delete state[d.from]; }

    lastMove=d.last_move;
    turnDisplay.textContent="Am Zug: "+d.next_turn;
    if(d.time) clocks=d.time;

    moveSound.currentTime = 0;
    moveSound.play();

    draw();
});

socket.on("chat",m=>{
    chatlog.innerHTML+=m+"<br>";
    chatlog.scrollTop=chatlog.scrollHeight;
});

socket.on("full",()=>info.textContent="Spiel ist voll!");

draw();
</script>

<script>
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js");
}
</script>

</body>
</html>
